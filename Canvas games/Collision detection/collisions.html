<!DOCTYPE html>
<html>
    <head>
        <style>
            canvas {
                border: solid black 1px;
            }
        </style>
        <script>
        var context,canavs,scoreParagraph;
        var ball1, ball2;
        var intervalId;
        var paddle;
        var score;
        function startGame(){
            setupGame();
            intervalId = setInterval(playGame, 15);
        }
        
        function setupGame(){
            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d");
            score = document.getElementById("score");
            ball1 = new Ball(50, 50, 1, 2, 30, "red");
            ball2 = new Ball(50, 300, -2, -1, 20, "pink");
            paddle = new Paddle(150, 590, 5, 0, "blue");
            window.addEventListener("keydown", keyDown);
            window.addEventListener("keyup", keyUp);
        } 
        
        function playGame(){
            context.clearRect(0,0,400,600);
            ball1.move();
            ball2.move();
            paddle.move();
            
            ball1.draw();
            ball2.draw();
            paddle.draw();
            
        }
            
        function stopGame(){
            console.clear();
            clearInterval(intervalId);
        }
        
        function updateRateOfChange(value, change, lowerBound, upperBound){
            if (lowerBound>value+change || upperBound<value+change){
                change= - change
            }
            return change;
        }
            
        function keyDown(event){
            paddle.keyDown(event);
        }
            
        function keyUp(event){
            paddle.keyUp(event);
        }
            
        function detectBallCollision(ball_a, ball_b){
            if (ball_a.disappeared||ball_b.disappeared){
                return;
            }
            //Detects whether two balls colide and if so makes them rebound
            var dist_x = ball_a.x-ball_b.x //Sign possibly inverted
            var dist_y = ball_a.y-ball_b.y //Sign possibly inverted
            var euc_distance_squared = Math.pow(dist_x, 2) + Math.pow(dist_y, 2);
            
            if (euc_distance_squared <= Math.pow(ball_a.radius+ball_b.radius, 2)){
                ball_a.dx*=-1;
                ball_a.dy*=-1;
                ball_b.dx*=-1;
                ball_b.dy*=-1;
            }
        }
        
        function detectPaddleCollision(ball){
            if (ball.hasHitBottomOfScreen()){
                if (paddle.x <= ball.x && ball.x <= paddle.x+paddle.width){
                    console.log("Paddleâ€“ball collision", ball.colour);
                    score+=1;
                    ball.dy*=-1
                } else{
                    ball.disappeared = true;
                    ball.x = 1000000;
                    ball.y = 1000000;
                }
            }
            
        }
        function Ball(x, y, dx, dy, radius, colour){
            //Returns a ball object which moves around the canvas 
            this.x = x;
            this.y = y;
            this.dx = dx;
            this.dy = dy;
            this.radius = radius;
            this.colour = colour;
            
            this.draw = function(){
                if (this.disappeared){
                    return;
                }
                //Draws the ball in its current state
                drawSolidCircle(this.x, this.y, this.radius, this.colour);
            }
            
            this.move = function(){
                if (this.disappeared){
                    return;
                }
                //Moves the ball within the canvas
                detectBallCollision(ball1, ball2);
                detectPaddleCollision(this);
                this.dx = updateRateOfChange(this.x, this.dx, this.radius, 400-this.radius);
                this.dy = updateRateOfChange(this.y, this.dy, this.radius, 600-this.radius);
                this.x+=this.dx;
                this.y+=this.dy;
                
            }
            
            this.hasHitBottomOfScreen = function(){
                return this.y+this.radius>=600;
            }
            
        }
        
        function Paddle(x,y,dx,dy, colour){
            this.x = x;
            this.y = y;
            this.dx = dx;
            this.dy = dy;
            this.leftKeyPressed = false;
            this.rightKeyPressed = false;
            this.colour = colour;
            this.width = 100;
            this.height = 10;
            this.disappeared=  false;
            
            this.draw = function(){
                drawSolidRect(this.x, this.y, this.width, this.height, this.colour);
            }
            
            this.keyDown = function(event){
                if (event.keyCode == 39){ this.rightKeyPressed = true;}
                if (event.keyCode == 37){ this.leftKeyPressed = true; }
            }
            
            this.keyUp = function(event){
                if (event.keyCode == 39){ this.rightKeyPressed = false;}
                if (event.keyCode == 37){ this.leftKeyPressed = false;}
            }
            
            this.move = function(){
                
                if (this.leftKeyPressed){ this.x=Math.max(this.x-this.dx,0); }
                if (this.rightKeyPressed){this.x=Math.min(this.x+this.dx,400-this.width); }
            }
        }
        
        function drawSolidRect(x, y, width, height, fillColour){
             //Draws a filled in rectangle of width*height with x,y as the upper left corner
            context.beginPath();
            context.width = 0;
            context.rect(x,y, width, height);
            context.fillStyle = fillColour;
            context.fill();
            context.closePath();
        }
            
        function drawSolidCircle(x,y, radius, fillStyle){
            //Draws a solid circle with x,y as the centre point
            context.beginPath();
            context.arc(x, y, radius,0 , Math.PI*2, false);
            context.fillStyle = fillStyle;
            context.fill();
            context.closePath();
        }
            
        function displayScore(){
            scoreParagraph.innerHTML = String(score);
        }
        </script>
    </head>
    <body>
        <canvas id="canvas" height="600px" width="400px"></canvas>
        <br />
        <button onclick="startGame()"> Start Game</button>
        <button onclick="stopGame()"> Stop Game</button>
        <p id="score">0</p>
    </body> 
</html>